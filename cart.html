<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Test</title>
</head>
<body>

</body>
</html>
<script src="vdom.js"></script>
<script>
    class ShopItem {
        constructor(name, num, checked) {
            this.name = name;
            this.num = num;
            this.checked = checked;
            this.deleted = false;
        }
        render() {
            return createComponent(this.name, this.num, this.checked);
        }
    }

    let store = {
        shopItems: [],
        disabled: false
    };

    function createBody(store) {
        let shopItemvDomArr = [];
        for (let item of store.shopItems) {
            shopItemvDomArr.push(item.render());
        }
        let ol = vDomOperator.createElement("ol", {id: "list"}, shopItemvDomArr);
        return [ol, vDomOperator.createElement(
            "div", {id: "container"},
            ol,
            vDomOperator.createElement("button", {
                id: "selectAll",
                disabled: store.disabled ? "disabled" : "",
                onclick: selectAll
            }, "Select All"),
            vDomOperator.createElement("button", {
                id: "invertSelect",
                disabled: store.disabled ? "disabled" : "",
                onclick: invertSelect
            }, "Invert Select"),
            vDomOperator.createElement("button", {
                id: "deleteSelect",
                disabled: store.disabled ? "disabled" : "",
                onclick: deleteSelect
            }, "Delete Select"),
            vDomOperator.createElement("br", {id: "br1"}),
            vDomOperator.createElement("input", {id: "Item Name"}),
            vDomOperator.createElement("button", {id: "addOne", onclick: addOne}, "Add One"),
        )];
    }

    function createComponent(id, num, checked) {
        return vDomOperator.createElement(
            "li", {id: "li_" + id},
            vDomOperator.createElement("input", {
                id: "check_" + id,
                type: "checkbox",
                name: id,
                checked: checked ? "checked" : "",
                onchange: updatevDomCheckBox
            }),
            vDomOperator.createElement("span", {
                id: "title_" + id
            }, id),
            vDomOperator.createElement("button", {
                id: "min_" + id,
                name: id
            }, "-"),
            vDomOperator.createElement("input", {
                id: "num_" + id,
                type: "input",
                value: num
            }, "-"),
            vDomOperator.createElement("button", {
                id: "add_" + id,
                name: id
            }, "+"),
            vDomOperator.createElement("button", {
                id: "del_" + id,
                name: id
            }, "Delete")
        );
    }

    for (let i = 1; i <= 3; i++) {
        let shopItem = new ShopItem("test" + i, 1, false);
        store.shopItems.push(shopItem);
    }

    let [vOL, vBody] = createBody(store);
    vBody.render(document.body);

    function updatevDomCheckBox(e) {
        let itemName = e.target.name;
        for (let item of store.shopItems) {
            if (itemName === item.name) {
                item.checked = e.target.checked;
                break;
            }
        }
        let [ol, newTree] = createBody(store);
        diffvDom(vOL, ol);
    }

    function selectAll() {
        for (let item of store.shopItems) {
            item.checked = true;
        }
        let [ol, newTree] = createBody(store);
        diffTree(vOL, ol);
    }

    function invertSelect() {
        let i = 0;
        for (let item of store.shopItems) {
            item.checked = !item.checked;
        }
        let [ol, newTree] = createBody(store);
        diffTree(vOL, ol);
    }

    function deleteSelect() {
        let [ol, newTree] = createBody(store);
        ol.children = ol.children.filter((item, index, array) => {
            if (vOL.children[index].children[0].props.checked === "checked") {
                store.shopItems[index].deleted = true;
                return false;
            } else {
                return true;
            }
        });
        store.shopItems = store.shopItems.filter((item, index, array) => {
            return !item.deleted;
        });
        diffTree(vOL, ol);
    }

    function addOne() {

    }

    function diffTree(oldTree, newTree) {
        let diff = vDomOperator.diff(oldTree, newTree);
        console.log(oldTree,newTree,diff);
        vDomOperator.patch(diff);
    }

    function diffvDom(oldTree,newTree) {
        let diff = vDomOperator.diff(oldTree, newTree);
        vDomOperator.patch(diff,false);
    }
</script>